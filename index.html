<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Decodificador VIN — Básico (Marca/Modelo/Motor/etc.)</title>
<style>
  :root{ --bg:#0f1724; --card:#0b1220; --accent:#38bdf8; --muted:#94a3b8; --glass:rgba(255,255,255,0.03);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  *{ box-sizing:border-box }
  body{ margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
        background:linear-gradient(180deg,#071025 0%,#07182b 100%); color:#e6eef8; padding:18px; }
  .container{ width:100%; max-width:1100px; background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
    border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,.7); padding:18px; border:1px solid rgba(255,255,255,.03); }
  header{ display:flex; gap:12px; align-items:center; margin-bottom:12px }
  header h1{ font-size:18px; margin:0 }
  header p{ margin:0; color:var(--muted); font-size:13px }
  form{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px }
  input[type="text"]{ flex:1 1 420px; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.06);
    background:var(--glass); color:inherit; font-size:14px }
  input[type="number"]{ width:120px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,.06);
    background:var(--glass); color:inherit; font-size:14px }
  button{ padding:10px 12px; border-radius:8px; border:0; background:var(--accent); color:#012135; font-weight:600;
    cursor:pointer; font-size:14px }
  button.secondary{ background:transparent; border:1px solid rgba(255,255,255,.06); color:var(--muted) }
  .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:12px }
  .card{ background:rgba(255,255,255,.02); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,.03) }
  .video-wrap{ position:relative; overflow:hidden; border-radius:8px; border:1px solid rgba(255,255,255,.04);
    background:#000; display:flex; align-items:center; justify-content:center; min-height:260px }
  video{ width:100%; height:auto; display:block; transform:scaleX(-1); }
  #overlayBox{ position:absolute; border:2px dashed rgba(56,189,248,.9); pointer-events:auto; cursor:move; width:68%; height:18%;
    left:16%; bottom:12%; box-sizing:border-box; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:13px }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .muted{ color:var(--muted); font-size:13px }
  .kv-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .kv{ background:rgba(255,255,255,.01); padding:8px; border-radius:8px; font-size:13px }
  .kv b{ display:block; color:var(--muted); font-weight:600; margin-bottom:6px }
  .badge{ display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; font-weight:700 }
  .ok{ background:#0ea5e9; color:#012135 }
  .warn{ background:#fbbf24; color:#012135 }
  .err{ background:#ef4444; color:white }
  @media(max-width:1000px){ .grid{ grid-template-columns:1fr } video{ height:260px; object-fit:cover } }
</style>
<!-- Tesseract.js para OCR local -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.3/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container" role="main">
  <header>
    <div>
      <h1>Decodificador VIN (básico) + Cámara/Imagen + Check Digit</h1>
      <p>Salida limitada a: marca, modelo, motor, fabricación, peso, color, transmisión y tamaño de rueda.</p>
    </div>
  </header>

  <form id="vinForm" onsubmit="return false;">
    <input id="vinInput" type="text" placeholder="Ej: 1HGCM82633A004352" maxlength="34" autocomplete="off" />
    <input id="yearInput" type="number" placeholder="Año (opcional)" min="1900" max="2035" />
    <div style="display:flex;gap:8px">
      <button id="decodeBtn" type="button">Decodificar</button>
      <button id="clearBtn" class="secondary" type="button">Limpiar</button>
    </div>
  </form>

  <div class="grid">
    <!-- Cámara + Imagen -->
    <div class="card">
      <div class="video-wrap" id="videoWrap">
        <video id="video" autoplay playsinline></video>
        <div id="overlayBox" title="Arrastra y ajusta sobre el VIN">Caja de recorte</div>
      </div>
      <div class="controls">
        <button id="startCamBtn" type="button">Abrir cámara</button>
        <button id="stopCamBtn" type="button" class="secondary">Detener cámara</button>
        <button id="captureBtn" type="button" class="secondary">Capturar</button>
        <label class="muted" style="display:flex;align-items:center;gap:6px"><input id="continuousCheckbox" type="checkbox"> Escaneo continuo</label>
        <label class="muted">Intervalo
          <input id="scanInterval" type="number" min="400" max="5000" value="1500" style="width:90px;margin-left:6px;padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,.06);color:inherit"> ms
        </label>
        <label class="muted" style="margin-left:auto">Imagen:
          <input id="fileInput" type="file" accept="image/*" style="margin-left:6px">
        </label>
      </div>
      <div id="ocrProgress" class="muted" style="margin-top:8px">Estado: inactivo</div>
    </div>

    <!-- Resultado básico -->
    <div class="card" id="resultArea" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Resultado (básico)</strong></div>
        <div class="muted">API: NHTSA vPIC</div>
      </div>

      <div style="margin-top:10px" class="kv-grid">
        <div class="kv"><b>VIN detectado</b><div id="detectedVin">(vacío)</div></div>
        <div class="kv"><b>Check digit</b><div id="checkDigitBox"><span class="badge warn">Sin verificar</span></div></div>
        <div class="kv"><b>Acciones</b>
          <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
            <button id="copyVinBtn" class="secondary" type="button">Copiar VIN</button>
            <button id="openNhtsaBtn" class="secondary" type="button">Abrir en NHTSA</button>
            <button id="forceDecodeBtn" type="button">Decodificar ahora</button>
          </div>
        </div>
      </div>

      <div id="basicCard" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* =======================
   Config y helpers
   ======================= */
const BASE = 'https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/';
const vinInput = document.getElementById('vinInput');
const yearInput = document.getElementById('yearInput');
const decodeBtn = document.getElementById('decodeBtn');
const clearBtn = document.getElementById('clearBtn');
const detectedVinEl = document.getElementById('detectedVin');
const checkDigitBox = document.getElementById('checkDigitBox');
const basicCard = document.getElementById('basicCard');

const video = document.getElementById('video');
const startCamBtn = document.getElementById('startCamBtn');
const stopCamBtn = document.getElementById('stopCamBtn');
const captureBtn = document.getElementById('captureBtn');
const overlayBox = document.getElementById('overlayBox');
const ocrProgress = document.getElementById('ocrProgress');
const continuousCheckbox = document.getElementById('continuousCheckbox');
const scanIntervalInput = document.getElementById('scanInterval');
const fileInput = document.getElementById('fileInput');

let stream = null;
let worker = null;
let scanTimer = null;
let ocrRunning = false;

// VIN regex y limpieza
const VIN_CLEAN_REGEX = /[A-HJ-NPR-Z0-9]/gi;
const VIN_FULL_REGEX  = /([A-HJ-NPR-Z0-9\-\s]{17,28})/gi;

function ocrHeuristicFix(str) {
  if(!str) return str;
  let s = str.toUpperCase().replace(/[^\w\s\-]/g,'');
  s = s.replace(/O/g,'0').replace(/I/g,'1').replace(/Q/g,'0');
  s = s.replace(/(?<=\d)S(?=\d)/g,'5').replace(/(?<=\d)Z(?=\d)/g,'2').replace(/(?<=\d)B(?=\d)/g,'8');
  return s;
}
function sanitizeVin(v){
  if(!v) return '';
  const only = (ocrHeuristicFix(v).match(VIN_CLEAN_REGEX)||[]).join('');
  return only.toUpperCase().slice(0,17);
}

/* =======================
   Check Digit (ISO 3779)
   ======================= */
const translit = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,J:1,K:2,L:3,M:4,N:5,P:7,R:9,S:2,T:3,U:4,V:5,W:6,X:7,Y:8,Z:9};
const weights = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2];
function computeCheckDigit(vin){
  if(!vin || vin.length!==17) return null;
  let sum=0;
  for(let i=0;i<17;i++){
    const ch=vin[i];
    let val = /\d/.test(ch) ? +ch : (/[A-Z]/.test(ch) ? (translit[ch]||0) : 0);
    sum += val*weights[i];
  }
  const r = sum%11;
  return r===10 ? 'X' : String(r);
}
function validateVinWithCheckDigit(vin){
  if(!vin || vin.length!==17) return {status:'unknown'};
  const provided = vin[8];
  const computed = computeCheckDigit(vin);
  if(computed==null) return {status:'unknown'};
  return {status: provided===computed ? 'valid':'invalid', provided, computed};
}
function renderCheckDigitStatus(vin){
  const res = validateVinWithCheckDigit(vin);
  if(res.status==='valid'){
    checkDigitBox.innerHTML = `<span class="badge ok">OK</span> (provisto: <b>${res.provided}</b>, calculado: <b>${res.computed}</b>)`;
  } else if(res.status==='invalid'){
    checkDigitBox.innerHTML = `<span class="badge err">NO coincide</span> (provisto: <b>${res.provided}</b>, calc: <b>${res.computed}</b>)`;
  } else {
    checkDigitBox.innerHTML = `<span class="badge warn">Sin verificar</span>`;
  }
}

/* =======================
   Campos BÁSICOS (solo estos)
   ======================= */
/*
  Mapeo a campos de vPIC (usamos el primero disponible de la lista):
  - Marca: Make, Manufacturer, ManufacturerName
  - Modelo: Model
  - Motor: EngineModel, EngineConfiguration, EngineCylinders, EngineHP/EngineKW, DisplacementL/CC/CI
  - Fabricación (lugar/año): ModelYear, PlantCountry, PlantState, PlantCity
  - Peso: GVWR, GVWRFrom/GVWRTo, GrossVehicleWeightRatingFrom/To
  - Color: Color, ExteriorColor (si existe), InteriorColor (no la mostramos salvo que Color falte)
  - Transmisión: TransmissionStyle, TransmissionSpeeds
  - Tamaño de rueda: WheelSizeFront, WheelSizeRear, WheelBase*, Tire* (si existen)
*/
const BASIC_FIELDS = [
  {label:'Marca', keys:['Make','Manufacturer','ManufacturerName']},
  {label:'Modelo', keys:['Model']},
  {label:'Motor', combine: (r)=>{
    const parts = [];
    const push = (k,fmt=(v)=>v)=>{ const val=r[k]; if(val) parts.push(fmt(val)); };
    push('EngineModel');
    push('EngineConfiguration');
    const cyl = r['EngineCylinders']; if(cyl) parts.push(`${cyl} cilindros`);
    const hp = r['EngineHP'], kw = r['EngineKW'];
    if(hp) parts.push(`${hp} HP`);
    else if(kw) parts.push(`${kw} kW`);
    const dispL = r['DisplacementL'] || r['Displacement'];
    const dispCC = r['DisplacementCC'], dispCI = r['DisplacementCI'];
    if(dispL) parts.push(`${dispL} L`);
    else if(dispCC) parts.push(`${dispCC} cc`);
    else if(dispCI) parts.push(`${dispCI} ci`);
    return parts.join(' · ') || null;
  }},
  {label:'Fabricación', combine:(r)=>{
    const yr = r['ModelYear'];
    const country = r['PlantCountry'], state=r['PlantState'], city=r['PlantCity'];
    const loc = [city,state,country].filter(Boolean).join(', ');
    return [yr ? `Año: ${yr}` : null, loc ? `Planta: ${loc}` : null].filter(Boolean).join(' · ') || null;
  }},
  {label:'Peso (GVWR)', combine:(r)=>{
    const gvwr = r['GVWR'] || r['GVWRFrom'] || r['GrossVehicleWeightRatingFrom'] || r['GVWR_to'] || r['GrossVehicleWeightRatingTo'];
    return gvwr || null;
  }},
  {label:'Color', keys:['Color','ExteriorColor']},
  {label:'Transmisión', combine:(r)=>{
    const style = r['TransmissionStyle'];
    const spd = r['TransmissionSpeeds'];
    if(style && spd) return `${style} · ${spd} vel.`;
    return style || spd || null;
  }},
  {label:'Tamaño de rueda', combine:(r)=>{
    const f = r['WheelSizeFront'], rr = r['WheelSizeRear'];
    const wb = r['WheelBase'] || r['WheelBaseType'] || r['WheelBaseShort'] || r['WheelBaseLong'];
    if(f && rr) return `Del.: ${f} · Tras.: ${rr}`;
    if(f) return `Del.: ${f}`;
    if(rr) return `Tras.: ${rr}`;
    return wb || r['TireSize'] || r['TireSizeFront'] || r['TireSizeRear'] || null;
  }},
];

function pickFirst(res, keys){
  for(const k of keys){ if(res[k]) return res[k]; }
  return null;
}

function renderBasicCard(res){
  const wrap = document.createElement('div');
  wrap.className='card';
  const grid = document.createElement('div');
  grid.className='kv-grid';

  BASIC_FIELDS.forEach(def=>{
    let val = null;
    if(def.combine) val = def.combine(res);
    else if(def.keys) val = pickFirst(res, def.keys);
    if(!val || String(val).trim()==='') val = '(sin dato)';

    const kv = document.createElement('div');
    kv.className='kv';
    kv.innerHTML = `<b>${def.label}</b><div>${val}</div>`;
    grid.appendChild(kv);
  });

  wrap.appendChild(grid);
  return wrap;
}

/* =======================
   Decodificación (vPIC)
   ======================= */
async function decodeVin(auto=false){
  const rawVin = sanitizeVin(vinInput.value);
  const year = yearInput.value ? parseInt(yearInput.value,10) : null;

  if(!rawVin){
    if(!auto) alert('Introduce un VIN válido.');
    return;
  }
  if(rawVin.length!==17 && !auto){
    if(!confirm('El VIN no tiene 17 caracteres. ¿Continuar?')) return;
  }

  renderCheckDigitStatus(rawVin);
  detectedVinEl.textContent = rawVin;
  basicCard.innerHTML = `<div class="card"><em>Decodificando…</em></div>`;

  try{
    let url = BASE + encodeURIComponent(rawVin) + '?format=json';
    if(year) url += '&modelyear=' + encodeURIComponent(year);
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const result = data?.Results?.[0];
    if(!result){ basicCard.innerHTML = '<div class="card">Sin resultados.</div>'; return; }
    basicCard.innerHTML = '';
    basicCard.appendChild(renderBasicCard(result));
  } catch(err){
    console.error(err);
    basicCard.innerHTML = `<div class="card"><strong>Error:</strong> ${err.message||err}</div>`;
  }
}

/* =======================
   Cámara + OCR (cliente)
   ======================= */
async function startCamera(){
  try{
    if(stream) return;
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    video.srcObject = stream;
    ocrProgress.textContent = 'Cámara activa';
    initTesseract().catch(()=>{});
  }catch(e){
    ocrProgress.textContent = 'Error cámara: '+(e.message||e);
  }
}
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; stream=null; }
  stopContinuousScan();
  ocrProgress.textContent = 'Cámara detenida';
}

// overlay draggable
(function(){
  let isDown=false, startX=0, startY=0, origLeft=0, origTop=0;
  overlayBox.addEventListener('pointerdown', (e)=>{
    isDown=true; overlayBox.setPointerCapture(e.pointerId);
    startX=e.clientX; startY=e.clientY;
    const rc=overlayBox.getBoundingClientRect();
    const parent=document.getElementById('videoWrap').getBoundingClientRect();
    origLeft=rc.left-parent.left; origTop=rc.top-parent.top;
  });
  window.addEventListener('pointermove', (e)=>{
    if(!isDown) return;
    const parent=document.getElementById('videoWrap').getBoundingClientRect();
    let nx=origLeft+(e.clientX-startX), ny=origTop+(e.clientY-startY);
    nx=Math.max(0,Math.min(nx,parent.width-overlayBox.offsetWidth));
    ny=Math.max(0,Math.min(ny,parent.height-overlayBox.offsetHeight));
    overlayBox.style.left=(nx/parent.width*100)+'%';
    overlayBox.style.top=(ny/parent.height*100)+'%';
    overlayBox.style.bottom='auto';
  });
  window.addEventListener('pointerup', ()=>{ isDown=false; });
})();

async function initTesseract(){
  if(worker) return;
  ocrProgress.textContent = 'Inicializando OCR...';
  worker = Tesseract.createWorker({ logger: m=>{
    if(m.status==='recognizing text' && m.progress!=null) ocrProgress.textContent = `OCR: ${(m.progress*100|0)}%`;
    else if(m.status) ocrProgress.textContent = `OCR: ${m.status}`;
  }});
  await worker.load();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK });
  ocrProgress.textContent = 'OCR listo';
}

function captureFrameToCanvas(){
  const vw=video.videoWidth, vh=video.videoHeight;
  if(!vw||!vh) return null;
  const videoRect=video.getBoundingClientRect();
  const overlayRect=overlayBox.getBoundingClientRect();
  const scaleX=vw/videoRect.width, scaleY=vh/videoRect.height;
  const sx=(overlayRect.left-videoRect.left)*scaleX;
  const sy=(overlayRect.top-videoRect.top)*scaleY;
  const sw=overlayRect.width*scaleX, sh=overlayRect.height*scaleY;
  const canvas=document.createElement('canvas');
  canvas.width=sw; canvas.height=sh;
  const ctx=canvas.getContext('2d');
  ctx.translate(canvas.width,0); ctx.scale(-1,1); // des-espejar
  ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
  return canvas;
}

async function doOcrFromVideo(){
  if(!stream){ ocrProgress.textContent='Cámara no iniciada'; return; }
  if(ocrRunning) return;
  ocrRunning=true;
  try{
    await initTesseract();
    const canvas=captureFrameToCanvas();
    if(!canvas){ ocrProgress.textContent='Esperando video...'; ocrRunning=false; return; }
    const res=await worker.recognize(canvas.toDataURL('image/jpeg', .9));
    processOcrText(res?.data?.text || '');
  }catch(e){
    ocrProgress.textContent='Error OCR: '+(e.message||e);
  }finally{ ocrRunning=false; }
}

fileInput.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  await initTesseract();
  const img = new Image();
  const url = URL.createObjectURL(f);
  img.onload = async ()=>{
    try{
      const maxW=1600, scale=Math.min(1, maxW/img.width);
      const c=document.createElement('canvas');
      c.width=Math.round(img.width*scale); c.height=Math.round(img.height*scale);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const res = await worker.recognize(c.toDataURL('image/jpeg', .92));
      processOcrText(res?.data?.text || '');
    } finally { URL.revokeObjectURL(url); }
  };
  img.onerror = ()=>{ ocrProgress.textContent='No se pudo leer la imagen.'; URL.revokeObjectURL(url); };
  img.src = url;
});

function processOcrText(rawText){
  if(!rawText || !rawText.trim()){ ocrProgress.textContent='OCR: sin texto'; return; }
  const txt = ocrHeuristicFix(rawText);
  const candidates = [];
  let m;
  while((m = VIN_FULL_REGEX.exec(txt)) !== null) candidates.push(m[1]);
  if(candidates.length===0){
    const flat=(txt.match(VIN_CLEAN_REGEX)||[]).join('');
    for(let i=0;i+17<=flat.length;i++) candidates.push(flat.slice(i,i+17));
  }
  let chosen=null, best= -1;
  for(const c of candidates){
    const s=sanitizeVin(c);
    if(s.length===17){
      const chk=validateVinWithCheckDigit(s);
      const score = chk.status==='valid'?2 : chk.status==='invalid'?0 : 1;
      if(score>best){ best=score; chosen=s; }
      if(score===2) break;
    }
  }
  if(chosen){
    vinInput.value = chosen;
    detectedVinEl.textContent = chosen;
    renderCheckDigitStatus(chosen);
    ocrProgress.textContent = 'VIN detectado: '+chosen;
    decodeVin(true);
  } else {
    ocrProgress.textContent = 'No se detectó un VIN válido en la imagen.';
  }
}

/* =======================
   Escaneo continuo & UI
   ======================= */
function startContinuousScan(){
  if(scanTimer) return;
  const intv = Math.max(400, parseInt(scanIntervalInput.value,10)||1500);
  scanTimer = setInterval(()=>{ doOcrFromVideo(); }, intv);
  ocrProgress.textContent='Escaneo continuo activo';
}
function stopContinuousScan(){
  if(scanTimer){ clearInterval(scanTimer); scanTimer=null; ocrProgress.textContent='Escaneo continuo detenido'; }
}

decodeBtn.addEventListener('click', ()=>decodeVin(false));
clearBtn.addEventListener('click', ()=>{
  vinInput.value=''; yearInput.value=''; detectedVinEl.textContent='(vacío)';
  checkDigitBox.innerHTML='<span class="badge warn">Sin verificar</span>'; basicCard.innerHTML='';
});

startCamBtn.addEventListener('click', ()=>startCamera());
stopCamBtn.addEventListener('click', ()=>stopCamera());
captureBtn.addEventListener('click', ()=>doOcrFromVideo());
continuousCheckbox.addEventListener('change', ()=> continuousCheckbox.checked? startContinuousScan(): stopContinuousScan());

document.getElementById('copyVinBtn').addEventListener('click', ()=>{
  const v=vinInput.value||detectedVinEl.textContent;
  if(!v||v==='(vacío)') return alert('No hay VIN para copiar.');
  navigator.clipboard?.writeText(v).then(()=>alert('VIN copiado.'));
});
document.getElementById('openNhtsaBtn').addEventListener('click', ()=>{
  const v=vinInput.value||detectedVinEl.textContent;
  if(!v||v==='(vacío)') return alert('No hay VIN para abrir.');
  window.open('https://vpic.nhtsa.dot.gov/decoder/?vin='+encodeURIComponent(v),'_blank');
});
document.getElementById('forceDecodeBtn').addEventListener('click', ()=>decodeVin(false));

window.addEventListener('beforeunload', ()=>{
  stopCamera();
  if(worker && worker.terminate) worker.terminate();
});

// placeholder
vinInput.placeholder='Ej: 5YJXCCE45GFS01231';
</script>
</body>
</html>
